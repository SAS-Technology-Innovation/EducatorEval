import{a as C,g as T,R as V}from"./index.R_mOzHLH.js";import{z as M,A as B,h as b,B as $}from"./firebase.C_cAEJpe.js";import{u as w}from"./firestore.BPRng998.js";const k={},z=t=>{let i;const r=new Set,e=(s,o)=>{const a=typeof s=="function"?s(i):s;if(!Object.is(a,i)){const u=i;i=o??(typeof a!="object"||a===null)?a:Object.assign({},i,a),r.forEach(d=>d(i,u))}},n=()=>i,f={setState:e,getState:n,getInitialState:()=>c,subscribe:s=>(r.add(s),()=>r.delete(s)),destroy:()=>{(k?"production":void 0)!=="production"&&console.warn("[DEPRECATED] The `destroy` method will be unsupported in a future version. Instead use unsubscribe function returned by subscribe. Everything will be garbage-collected if store is garbage-collected."),r.clear()}},c=i=t(e,n,f);return f},G=t=>t?z(t):z;var I={exports:{}},D={},_={exports:{}},R={};/**
 * @license React
 * use-sync-external-store-shim.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var O;function H(){if(O)return R;O=1;var t=C();function i(o,a){return o===a&&(o!==0||1/o===1/a)||o!==o&&a!==a}var r=typeof Object.is=="function"?Object.is:i,e=t.useState,n=t.useEffect,p=t.useLayoutEffect,m=t.useDebugValue;function g(o,a){var u=a(),d=e({inst:{value:u,getSnapshot:a}}),l=d[0].inst,y=d[1];return p(function(){l.value=u,l.getSnapshot=a,f(l)&&y({inst:l})},[o,u,a]),n(function(){return f(l)&&y({inst:l}),o(function(){f(l)&&y({inst:l})})},[o]),m(u),u}function f(o){var a=o.getSnapshot;o=o.value;try{var u=a();return!r(o,u)}catch{return!0}}function c(o,a){return a()}var s=typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"?c:g;return R.useSyncExternalStore=t.useSyncExternalStore!==void 0?t.useSyncExternalStore:s,R}var W;function J(){return W||(W=1,_.exports=H()),_.exports}/**
 * @license React
 * use-sync-external-store-shim/with-selector.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var L;function K(){if(L)return D;L=1;var t=C(),i=J();function r(c,s){return c===s&&(c!==0||1/c===1/s)||c!==c&&s!==s}var e=typeof Object.is=="function"?Object.is:r,n=i.useSyncExternalStore,p=t.useRef,m=t.useEffect,g=t.useMemo,f=t.useDebugValue;return D.useSyncExternalStoreWithSelector=function(c,s,o,a,u){var d=p(null);if(d.current===null){var l={hasValue:!1,value:null};d.current=l}else l=d.current;d=g(function(){function x(h){if(!A){if(A=!0,v=h,h=a(h),u!==void 0&&l.hasValue){var S=l.value;if(u(S,h))return E=S}return E=h}if(S=E,e(v,h))return S;var N=a(h);return u!==void 0&&u(S,N)?(v=h,S):(v=h,E=N)}var A=!1,v,E,j=o===void 0?null:o;return[function(){return x(s())},j===null?void 0:function(){return x(j())}]},[s,o,a,u]);var y=n(c,d[0],d[1]);return m(function(){l.hasValue=!0,l.value=y},[y]),f(y),y},D}var P;function Q(){return P||(P=1,I.exports=K()),I.exports}var X=Q();const Y=T(X),F={},{useDebugValue:Z}=V,{useSyncExternalStoreWithSelector:U}=Y;let q=!1;const ee=t=>t;function te(t,i=ee,r){(F?"production":void 0)!=="production"&&r&&!q&&(console.warn("[DEPRECATED] Use `createWithEqualityFn` instead of `create` or use `useStoreWithEqualityFn` instead of `useStore`. They can be imported from 'zustand/traditional'. https://github.com/pmndrs/zustand/discussions/1937"),q=!0);const e=U(t.subscribe,t.getState,t.getServerState||t.getInitialState,i,r);return Z(e),e}const re=t=>{(F?"production":void 0)!=="production"&&typeof t!="function"&&console.warn("[DEPRECATED] Passing a vanilla store will be unsupported in a future version. Instead use `import { useStore } from 'zustand'`.");const i=typeof t=="function"?G(t):t,r=(e,n)=>te(i,e,n);return Object.assign(r,i),r},ne=t=>re,oe=t=>(i,r,e)=>{const n=e.subscribe;return e.subscribe=(m,g,f)=>{let c=m;if(g){const s=f?.equalityFn||Object.is;let o=m(e.getState());c=a=>{const u=m(a);if(!s(o,u)){const d=o;g(o=u,d)}},f?.fireImmediately&&g(o,o)}return n(c)},t(i,r,e)},ie=oe,le=ne()(ie((t,i)=>({firebaseUser:null,user:null,isLoading:!0,isAuthenticated:!1,error:null,signIn:async(r,e)=>{try{t({isLoading:!0,error:null}),await $(b,r,e)}catch(n){throw t({error:n instanceof Error?n.message:"Sign in failed",isLoading:!1}),n}},signOut:async()=>{try{await B(b),t({firebaseUser:null,user:null,isAuthenticated:!1,error:null})}catch(r){throw t({error:r instanceof Error?r.message:"Sign out failed"}),r}},initialize:()=>M(b,async e=>{if(t({isLoading:!0,error:null}),e)try{console.log("🔍 Checking for existing user:",e.email,"UID:",e.uid);let n=null;try{n=await w.getById(e.uid),n&&(console.log("✅ Found existing user by UID:",n.email),await w.update(e.uid,{lastLogin:new Date,updatedAt:new Date}))}catch(p){console.log("UID lookup failed (user may not exist):",p.message)}if(!n&&e.email){console.log("🔍 Searching for existing user by email...");try{const m=(await w.list()).find(g=>g.email===e.email);m&&(console.log("⚠️ Found existing user with different UID! Email:",m.email,"Existing UID:",m.id),console.log("🔧 This indicates a duplicate/orphaned record that should be cleaned up"),n=m)}catch(p){console.log("Email search failed:",p.message)}}!n&&e.email&&(console.log("❓ No existing user record found for:",e.email),console.log("⚠️ Auto-creation disabled to prevent duplicates"),console.log("📧 Email:",e.email),console.log("🆔 UID:",e.uid),console.log("👤 Display Name:",e.displayName),console.log(""),console.log("🚫 User not found in authorized users database."),console.log("Please contact an administrator to create your user profile."),n={id:e.uid,email:e.email,firstName:e.displayName?.split(" ")[0]||"User",lastName:e.displayName?.split(" ").slice(1).join(" ")||"",displayName:e.displayName||e.email.split("@")[0],employeeId:"",schoolId:"",divisionId:"",departmentId:"",primaryRole:"staff",secondaryRoles:[],permissions:[],jobTitle:"secretary",certifications:[],experience:"",subjects:[],grades:[],specializations:[],planningPeriods:[],languages:["English"],isActive:!1,accountStatus:"unauthorized",lastLogin:new Date,createdAt:new Date,updatedAt:new Date,metadata:{authOnly:!0,needsAuthorization:!0}}),t({firebaseUser:e,user:n,isAuthenticated:!0,isLoading:!1})}catch(n){console.error("Failed to load user data:",n);const p={id:e.uid,email:e.email||"",firstName:e.displayName?.split(" ")[0]||"User",lastName:e.displayName?.split(" ").slice(1).join(" ")||"",displayName:e.displayName||e.email?.split("@")[0]||"User",employeeId:`EMP-${e.uid.slice(-6).toUpperCase()}`,schoolId:"default-school",divisionId:"general",departmentId:"general",primaryRole:"educator",secondaryRoles:[],permissions:["view_own_profile"],jobTitle:"teacher",certifications:[],experience:"",subjects:[],grades:[],specializations:[],planningPeriods:[],languages:["English"],isActive:!0,accountStatus:"active",lastLogin:new Date,createdAt:new Date,updatedAt:new Date,metadata:{}};t({firebaseUser:e,user:p,isAuthenticated:!0,isLoading:!1,error:null})}else t({firebaseUser:null,user:null,isAuthenticated:!1,isLoading:!1})}),clearError:()=>t({error:null}),updateUser:async r=>{const{user:e}=i();if(!e)throw new Error("No user to update");try{await w.update(e.id,r),t({user:{...e,...r}})}catch(n){throw t({error:n instanceof Error?n.message:"Update failed"}),n}},hasRole:r=>{const{user:e}=i();return e?e.primaryRole===r||e.secondaryRoles.includes(r):!1},hasPermission:r=>{const{user:e}=i();return e?e.permissions.includes(r):!1},isAdmin:()=>{const{hasRole:r}=i();return r("super_admin")||r("administrator")},canObserve:()=>{const{hasRole:r}=i();return r("observer")||r("manager")||r("administrator")||r("super_admin")},canManage:()=>{const{hasRole:r}=i();return r("manager")||r("administrator")||r("super_admin")}})));export{le as u};
